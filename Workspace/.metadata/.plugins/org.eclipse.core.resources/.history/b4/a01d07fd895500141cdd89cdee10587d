package com.secondfloor;

import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.ProtocolException;
import java.net.URL;

import com.secondfloor.messages.EncontrarOfertaRequest;
import com.secondfloor.messages.EncontrarOfertaResponse;

import flexjson.JSONDeserializer;
import flexjson.JSONSerializer;

public class AnuncioRest {
	public EncontrarOfertaResponse EncontrarOfertasPorNomeProduto(String nomeProduto)
	{
		StringBuilder sb = new StringBuilder(); 
		
		EncontrarOfertaRequest request = new EncontrarOfertaRequest();
		request.setProduto(nomeProduto);
		//request.setBairro("bairro");
		//request.setTipoProduto("tipoProduto");
		
		//flexjson
		JSONSerializer jsonSerializer = new JSONSerializer();
		String requestStr = jsonSerializer.exclude("*.class").deepSerialize(request);
		
		
		System.out.println("JsonRequest: "+requestStr);
		
		//String http = "http://localhost:8080/web/EncontrarOfertaPor";
		String http = "http://localhost:1886/Service.svc/web/EncontrarOfertaPor";
		
		
		HttpURLConnection urlConnection=null;  
		try{
			//Connexao
			URL url = new URL(http);  
		    urlConnection = (HttpURLConnection) url.openConnection();
		    urlConnection.setDoOutput(true);   
		    urlConnection.setRequestMethod("POST");  
		    urlConnection.setUseCaches(false);  
		    urlConnection.setConnectTimeout(10000);  
		    urlConnection.setReadTimeout(10000);  
		    urlConnection.setRequestProperty("Content-Type","application/json; charset=utf-8");	
		    
		    DataOutputStream wr = new DataOutputStream(urlConnection.getOutputStream ());
		    wr.writeBytes(requestStr);
		    wr.flush();
		    wr.close();
		    
		    System.out.println("Codigo HTTP: " + urlConnection.getResponseCode()); //Codigo HTTP da resposta
		    Syst888888em.out.println("Mensagem HTTP: " + urlConnection.getResponseMessage()); //Mensagem HTTP de respost
		    
		    int HttpResult = urlConnection.getResponseCode();  
		    if(HttpResult == HttpURLConnection.HTTP_OK){
		    	
		    	InputStreamReader reader = new InputStreamReader(urlConnection.getInputStream());
		    	
		    	BufferedReader br = new BufferedReader(reader);
		    	
		    	String line = null;
		        while ((line = br.readLine()) != null) 
		        {  
		            sb.append(line + "\n");  
		        }
		        br.close();
		        
		        //Mensagem que veio do 
		        System.out.println("JsonResponse: " + sb.toString());
		        
		        //flexjson
		        EncontrarOfertaResponse response = new EncontrarOfertaResponse();
		        JSONDeserializer jsonDeserializer = new JSONDeserializer<EncontrarOfertaResponse>();
		        jsonDeserializer.deserializeInto(sb.toString(), response);
		        
		        
		        System.out.println("num ofertas: " + response.getOfertas().length);
		        
		        
		    }
		} 
		catch(MalformedURLException e)
		{
			e.printStackTrace();  
		} 
		catch (ProtocolException e) 
		{
			e.printStackTrace();
		} 
		catch (IOException e) 
		{
			e.printStackTrace();
		}finally{  
		    if(urlConnection!=null)  
		        urlConnection.disconnect();  
		} 
	}

}
